---
title: "Final Project Data Wrangling"
author: "Rhett Reyes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) 
library(tidyverse) 
library(readr) 
library(janitor) 
library(maps) 
library(tigris) 
library(sf) 
library(winch)
rm(list = ls())
```

```{r}
climate_change_usa <- read_csv("Data Frames (csv)/climate-change_usa.csv")
climdiv_county_year <- read_csv("Data Frames (csv)/climdiv_county_year.csv")
```

```{r}
names(climate_change_usa) <- names(climate_change_usa) %>% 
  make_clean_names() 
clean_climate_change_usa <- climate_change_usa %>%
  filter(row_number() != 1)  
```

```{r}
glimpse(clean_climate_change_usa) 
glimpse(climdiv_county_year)
```

```{r}
clean_climate_change_usa <- clean_climate_change_usa %>% 
  mutate(year = as.numeric(year), 
         value = as.numeric(value))
```

```{r}
us_counties <- counties(cb = TRUE, year = 2022, class = "sf")
glimpse(us_counties)  
climdiv_county_year <- climdiv_county_year %>% rename(GEOID = fips)
climdiv_county_year$GEOID <- as.character(climdiv_county_year$GEOID)
```


```{r}

# Join the temperature data with the spatial data
map_data <- us_counties %>%
  left_join(climdiv_county_year, by = "GEOID")
```

```{r}
test_map <- map_data %>% 
  filter(year == 1895)  
glimpse(test_map)
```

```{r}
blank_counties <- anti_join(us_counties,climdiv_county_year)  
blank_counties$GEOID <- as.numeric(blank_counties$GEOID)
blank_counties <- blank_counties %>% filter(GEOID < 60000) 
blank_counties$GEOID <- as.character(blank_counties$GEOID)
```

```{r}
test_map2 <- bind_rows(test_map,blank_counties) 
```

```{r}
test_map_df <- st_drop_geometry(test_map)
test_map3 <- us_counties %>% 
  left_join(test_map_df)
```


```{r} 
#Testing to see how mapping would turn out
ggplot(USA_by_Temp) +
  geom_sf(aes(fill = temp)) +
  scale_fill_viridis_c(option = "plasma",na.value = "gray", name = "Temperature") +
  theme_minimal() +
  labs(
    title = "US County-Level Temperatures",
    subtitle = "Temperatures by County",
    caption = "Data source: climdiv_county_year.csv"
  ) + 
   coord_sf(datum = NA,
          xlim = c(-125, -65), 
          ylim = c(24, 50)) 
```


```{r}
test_map <- map_data %>% 
  filter(year == 1897)
test_map_df <- st_drop_geometry(test_map)
test_map3 <- us_counties %>% 
  left_join(test_map_df)
```



```{r}
common_crs <- st_crs(4326)
us_counties <- st_transform(us_counties, common_crs)
USA_by_Temp <- st_sf(
  GEOID = character(),        # Assuming GEOID is a character
  year = integer(),           # Assuming year is an integer
  temperature = numeric(),    # Assuming temperature is numeric
  geometry = st_sfc(crs = common_crs)  # Create an empty geometry column with the common CRS
)
years <- (1895) 
#for(i in 1895:2019){ 
test_map5 <- map_data %>% 
  filter(year == 1897)
test_map_df <- st_drop_geometry(test_map)
test_map5 <- us_counties %>% 
  left_join(test_map_df)
USA_by_Temp <- bind_rows(USA_by_Temp,test_map5) 
#  }
```
```{r}
USA_by_Temp <- bind_rows(USA_by_Temp,test_map4)
```

```{r}
common_crs <- st_crs(4326)

# Transform us_counties to the common CRS
us_counties <- st_transform(us_counties, common_crs)

# Create an empty sf object for binding rows with the appropriate CRS
USA_by_Temp <- st_sf(
  GEOID = character(),        # Assuming GEOID is a character
  year = integer(),           # Assuming year is an integer
  temperature = numeric(),    # Assuming temperature is numeric
  geometry = st_sfc(crs = common_crs)  # Create an empty geometry column with the common CRS
)

# Loop through each year from 1895 to 2019
for (year in 1895:1897) {
  # Filter for the current year
  test_map <- map_data %>%
    filter(year == year)
  
  # Drop geometry to join with us_counties
  test_map_df <- st_drop_geometry(test_map)
  
  # Join with us_counties to get the geometry back and fill missing values
  test_map4 <- us_counties %>%
    left_join(test_map_df, by = "GEOID")
  
  # Ensure the joined data has the correct CRS
  test_map4 <- st_transform(test_map4, common_crs)
  
  # Append the result to USA_by_Temp
  USA_by_Temp <- bind_rows(USA_by_Temp, test_map4)
}

# Check the resulting combined data frame
head(USA_by_Temp)
```

```{r} 
#This is the chunk that produces the big data set
common_crs <- st_crs(4326)
us_counties <- st_transform(us_counties, common_crs)
USA_by_Temp <- st_sf(
  GEOID = character(),       
  year = integer(),          
  temperature = numeric(),   
  geometry = st_sfc(crs = common_crs)  # Create an empty geometry column with the common CRS
)
years <- (1895) 
for(i in 1895:2019){ 
test_map5 <- map_data %>% 
  filter(year == 1897)
test_map_df <- st_drop_geometry(test_map)
test_map5 <- us_counties %>% 
  left_join(test_map_df)
USA_by_Temp <- bind_rows(USA_by_Temp,test_map5) 
  }
```

```{r}
write.csv(USA_by_Temp,"~/Desktop/Data Wrangling/filename.csv", row.names = FALSE)
```

